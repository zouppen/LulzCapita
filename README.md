# LulzCapita investment tracker server

Stock portfolio exporter and analysis tool for people not afraid to
show what they've got.

More information coming later on...

## Database schema

The database document structure is defined below. The schema depends
on <tt>table</tt> field.

Possibly sensitive fields like transaction ID, bank ID and account ID
are hashed. The hash function is "half-SHA256", meaning that normal
SHA256 is calculated but only first half of its internal state is
returned. Initial value (so-called salt) is server dependant and is
defined in
<tt>[sink.conf](https://github.com/zouppen/lulzcapita/blob/master/sink.conf.example#L7)</tt>. More
about hash generation at
[Common.hs](https://github.com/zouppen/lulzcapita/blob/master/Common.hs#L48)
function <tt>hashGen</tt>.

### portfolio

* <tt>\_id</tt>: Transaction ID, hashed with bank id and account ID
* <tt>user</tt>: User ID
* <tt>date</tt>: Date of transaction
* <tt>sync</tt>: Synchronization ID
* <tt>type</tt>: Type of transaction. One of the following:
  * <tt>account</tt>: Deposit or withdraw, depending of the sign of sum
  * <tt>tax</tt>: Taxation.
  * <tt>sale</tt>: Purchase or sale, depending of the sign of count
  * <tt>income</tt>: Return of capital, dividents, interests
* <tt>count</tt>: In case of sales, this contains the number of stock or 
  security sold. In case of purcase, this is positive and in case of sale
  this is negative.
* <tt>isin</tt>: The ISIN of the stock in question.

In database, taxation on account interest, dividents and sales have
the type of "tax". In case of account taxation, "isin" field is null,
otherwise it contains the ISIN of that stock or security that has been
taxated.

### user

* <tt>\_id</tt>: User ID, autogenerated by CouchDB
* <tt>nick</tt>: Nickname
* <tt>portfolios</tt>: An array of portfolio IDs belonging to this user.
  ID's are hashed with bank ID.

### sync

* <tt>\_id</tt>: Autogenerated.
* <tt>portfolio</tt>: Portfolio ID, hashed as in user document.
* <tt>time</tt>: Unix timestamp.
* <tt>log</tt>: Log file of this synchronization.

Every synchronization generates a new document. Normally, only date is
interesting, but provides useful information for logging purposes.

## Database views

### balance

Stock or account balance. It sums all amounts of transactions.

When grouping level is 2:

* key: [User ID, ISIN]
* value: Stock balance

The balance represents amount of euros paid when purchasing that stock
minus dividents and sale price. Possible taxes are substracted. The
market value is not added.

When grouping level is 1:

* key: User ID
* value: Account balance

The number indicates euros on the account. It doesn't contain market
value or sales price of stocks.

### last_sync

Used to pick good start date in synchronization request.

* key: Portfolio ID
* value: Synchronization date (ISO 8601)

Portfolio ID is hashed. Synchronization date has more weird
algoritm. Because Nordnet actions are not coming immediately, the day
changes at 12:00 UTC next day. This ensures we get all transactions
from the database when using this date as start date in Nordnet
export. When more banks are supported, more heuristics may be added.

### portfolio_users

Used to find user ID for given portfolio ID.

* key: Portfolio ID
* value: null
* document: The user ID having that portfolio.

### stocks

Emits amount of bought stocks.

* key: [ISIN, User ID]
* value: Number of stocks

When grouping level is 1, the grand total is shown. That means sum of
stocks of all Lulzcapita users. It is used mainly in market value
downloader to select which ISINs of monitor.

### user_stocks

Emits amount of stocks per user. It can be used to in market value
viewer to find out number of stocks counts of a single user.

* key: [User ID, ISIN]
* value: number of stocks

Does NOT provide any meaningful information when grouping level is 1.

### users

Produces a list of users on a system. Used for system administration purposes.

* key: Nickname
* value: null
* document: User document

## Server configuration

TODO nginx instructions

## Installation

You have 2 sane options for building this. To build with operating
system libraries you need a rather new operating system like Debian
Wheezy or Ubuntu Oneiric. If you have older server, you should use
cabal-dev because the dependencies are quite messy.

These instructions are for Ubuntu. If you have other OS and the listed
packages are not available then you are a bit of your own. Try getting
Haskell Platform, CouchDB, CouchApp and Cabal-Dev and install patched
version of CouchDB library and of course, this app.  Feel free to send
a pull request containing installation instructions for other
operating systems.

### Ubuntu/Debian packages

Install the following packages with <tt>sudo apt-get install</tt> or
other package manager:

    cabal-install
    ghc
    libghc-parsec3-dev
    libghc-json-dev
    libghc-network-dev
    libghc-missingh-dev
    libghc-sha-dev
    libghc-configfile-dev
    libghc-fastcgi-dev
    libghc-utf8-string-dev
    libghc-datetime-dev
    libghc-mtl-dev
    libghc-http-dev
    couchapp
    couchdb
    spawn-fcgi

Libraries <tt>mtl</tt> and <tt>http</tt> are listed because they are
dependencies of CouchDB library. You can install <tt>couchapp</tt> on
any computer and <tt>couchdb</tt> on your database server. Of course
they may be the very same computer.

### Patched CouchDB library

This is required before arjunguha merges my pull request.

    git clone git://github.com/zouppen/haskell-couchdb.git --branch httpauth
    cd haskell-couchdb
    cabal install

### LulzCapita

    git clone git://github.com/zouppen/lulzcapita.git
    cd lulzcapita
    cabal install

After these commands, <tt>lulzcapita</tt> should be available on your
path, if not, then at <tt>~/.cabal/bin/lulzcapita</tt>.

### Couchapp

Our Couchapp contains some views of LulzCapita. Install them with
<tt>couchapp</tt>. On this source directory, run:

    cd couchapp
    couchapp push URL

You may omit URL if you are running CouchDB at localhost in admin
party mode. Please keep in mind that the database will receive
personal information and you should secure it. For more information,
please get a copy of [CouchDB: The Definitive
Guide](http://guide.couchdb.org/editions/1/en/index.html)

## Running

To run interactively as a FastCGI on port 9001.

    spawn-fcgi -n -p 9001 -- lulzcapita

To run in background you may omit the <tt>-n</tt> flag.
